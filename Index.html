<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PunchClock: Petty Edition ğŸš¨ğŸ‡¿ğŸ‡¦</title>

  <style>
    :root{
      --text:#eaf2ff;
      --muted:#b7c7dd;
      --line:rgba(255,255,255,.14);

      /* Panels: 30% opacity like you requested */
      --uiAlpha: .30;

      /* Background dimming (lower = brighter background) */
      --bgDimTop: .08;
      --bgDimBottom: .28;
      --bgBlur: 1px;

      --good:#2dd4bf;
      --bad:#fb7185;
      --warn:#fbbf24;

      --shadow: 0 18px 44px rgba(0,0,0,.55);
      --radius: 18px;

      /* Default background fallback (if you never pick one) */
      --bgImage:
        radial-gradient(1200px 700px at 30% 10%, rgba(120,70,255,.35), rgba(0,0,0,0) 60%),
        radial-gradient(900px 600px at 110% 20%, rgba(45,212,191,.22), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      padding: 16px 12px 28px;
      background: var(--bgImage) center/cover no-repeat fixed;
    }

    /* âœ… Lighter overlay so your background doesn't get murdered */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 600px at 20% 10%,
          rgba(0,0,0,var(--bgDimTop)),
          rgba(0,0,0,var(--bgDimBottom)) 70%),
        linear-gradient(180deg,
          rgba(0,0,0,var(--bgDimTop)),
          rgba(0,0,0,var(--bgDimBottom)));
      backdrop-filter: blur(var(--bgBlur));
      z-index:-1;
    }

    .wrap{max-width:980px;margin:0 auto}

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      line-height:1.1;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }

    .tagline{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      max-width: 72ch;
      text-shadow: 0 10px 26px rgba(0,0,0,.55);
    }

    .pillRow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(20,24,34,var(--uiAlpha));
      backdrop-filter: blur(10px);
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .pill b{color:var(--text)}

    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
      margin-top:12px;
    }
    @media (min-width:900px){
      .grid{grid-template-columns: 1.1fr .9fr; align-items:start;}
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;

      /* UI 30% opacity (background only) */
      background: rgba(18,22,34,var(--uiAlpha));
      backdrop-filter: blur(14px);
    }

    .sep{height:1px;background:var(--line);margin:12px 0}

    .clock{
      font-size: 40px;
      font-weight: 950;
      letter-spacing: .7px;
      margin: 6px 0 4px;
      text-shadow: 0 12px 28px rgba(0,0,0,.55);
    }

    .runningBanner{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,calc(var(--uiAlpha) + .10));
      backdrop-filter: blur(12px);
      color: var(--muted);
      font-size: 12px;
      line-height:1.2;
      flex-wrap:wrap;
    }

    .runningBanner.running{
      border-color: rgba(45,212,191,.55);
      color: var(--text);
      background: rgba(45,212,191,.12);
    }

    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.18);
      box-shadow: 0 0 0 0 rgba(45,212,191,.0);
    }

    .runningBanner.running .dot{
      background: var(--good);
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse{
      0% { box-shadow: 0 0 0 0 rgba(45,212,191,.45); }
      70% { box-shadow: 0 0 0 10px rgba(45,212,191,0); }
      100% { box-shadow: 0 0 0 0 rgba(45,212,191,0); }
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{flex:1;min-width:180px}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
      text-shadow: 0 10px 22px rgba(0,0,0,.55);
    }

    input,select,textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,calc(var(--uiAlpha) + .20));
      backdrop-filter: blur(10px);
      color: var(--text);
      outline:none;
    }

    textarea{min-height:44px;resize:vertical}

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }

    button{
      border-radius: 18px;
      padding: 16px 14px;
      border:1px solid var(--line);
      cursor:pointer;
      color:var(--text);
      font-weight: 950;
      letter-spacing:.35px;
      background: rgba(0,0,0,calc(var(--uiAlpha) + .22));
      backdrop-filter: blur(12px);
      box-shadow: 0 12px 30px rgba(0,0,0,.30);
      transition: transform .06s ease, filter .12s ease;
      touch-action: manipulation;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    button:active{transform:scale(.99);filter:brightness(1.06)}
    button[disabled]{opacity:.45;cursor:not-allowed;box-shadow:none}

    .btnStart{ border-color: rgba(45,212,191,.60); }
    .btnEnd{ border-width:2px; border-color: rgba(251,113,133,.65); }

    .tools{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .mini{
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing:.2px;
    }
    .right{margin-left:auto}

    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      text-shadow: 0 10px 22px rgba(0,0,0,.55);
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .stat{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,var(--uiAlpha));
      backdrop-filter: blur(12px);
      padding: 12px;
    }

    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:20px;font-weight:950;margin-top:4px}

    .sectionTop{display:flex;justify-content:space-between;align-items:baseline;gap:12px;flex-wrap:wrap}
    .list{display:grid;gap:10px;margin-top:10px}

    .item{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,var(--uiAlpha));
      backdrop-filter: blur(12px);
      padding: 12px;
    }

    .itemTop{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
    .dateLine{font-weight:950;letter-spacing:.2px;text-shadow: 0 10px 24px rgba(0,0,0,.55)}

    .badge{
      font-size:12px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,calc(var(--uiAlpha) + .15));
      backdrop-filter: blur(12px);
      white-space:nowrap;
    }
    .badge.normal{color:var(--muted)}
    .badge.sunday{border-color: rgba(251,191,36,.55); color: var(--warn)}
    .badge.holiday{border-color: rgba(251,191,36,.75); color: var(--warn)}

    .payBig{
      margin-top:10px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .payBig .pay{font-size:22px;font-weight:980;letter-spacing:.2px;text-shadow: 0 12px 28px rgba(0,0,0,.55)}
    .payBig .meta{font-size:12px;color:var(--muted)}

    .kvGrid{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:6px 10px}
    .kv{font-size:12px;color:var(--muted)}
    .kv b{color:var(--text);font-weight:900}

    .note{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      border-left: 3px solid rgba(255,255,255,.16);
      padding-left:10px;
      line-height:1.35;
    }

    .goodText{color:var(--good)}
    .badText{color:var(--bad)}
    .hidden{display:none}

    /* Dimmer slider styling */
    .sliderWrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .sliderWrap input[type="range"]{
      flex:1;
      min-width: 160px;
      height: 34px;
      padding: 0;
      background: transparent;
      border: none;
    }
    .sliderValue{
      font-size:12px;
      color:var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(20,24,34,var(--uiAlpha));
      backdrop-filter: blur(10px);
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>PunchClock: Petty Edition ğŸš¨ğŸ‡¿ğŸ‡¦</h1>
      <div class="tagline">
        Tap to clock in/out. Sundays pay <b>1.5x</b> ğŸ’¸. Public holidays pay <b>2x</b> ğŸ‰.
        Exports included ğŸ§¾ because payroll â€œmistakesâ€ love the dark. (Not here.)
      </div>

      <div class="pillRow">
        <div class="pill">ğŸ•’ Timezone: <b id="tzLabel">Africa/Johannesburg</b></div>
        <div class="pill">ğŸ‰ Holiday cache: <b id="holidayLabel">checkingâ€¦</b></div>
        <div class="pill">ğŸ”’ Log integrity: <b id="integrityLabel">checkingâ€¦</b></div>
        <div class="pill">ğŸ–¼ï¸ Background: <b id="bgLabel">default</b></div>
      </div>

      <div class="sliderWrap">
        <div class="pill">ğŸŒˆ Background dimmer</div>
        <input id="bgDimmer" type="range" min="0" max="60" value="22" />
        <div class="sliderValue" id="bgDimLabel">22%</div>
      </div>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="clock" id="clock">--:--:--</div>

      <div id="runningBanner" class="runningBanner">
        <span class="dot"></span>
        <span id="runningText">ğŸ˜´ No shift running.</span>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>ğŸ’° Base hourly rate (ZAR)</label>
          <input id="baseRate" type="number" min="0" step="0.01" placeholder="e.g. 120.00" />
        </div>

        <div class="field">
          <label>ğŸŒ Timezone mode</label>
          <select id="tzMode">
            <option value="ZA">Africa/Johannesburg (recommended)</option>
            <option value="DEVICE">Use device timezone</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <label>ğŸ“ Notes (optional)</label>
          <textarea id="notes" placeholder="e.g. 30 min unpaid break, covered extra shift, etc."></textarea>
        </div>
      </div>

      <div class="btns">
        <button class="btnStart" id="startBtn">ğŸŸ¢ START SHIFT</button>
        <button class="btnEnd" id="endBtn">ğŸ”´ END SHIFT</button>
      </div>

      <div class="tools">
        <button class="mini" id="refreshHolidaysBtn">ğŸ‰ Refresh holidays</button>
        <button class="mini" id="exportCsvBtn">ğŸ“„ Export CSV</button>
        <button class="mini" id="exportJsonBtn">ğŸ§¾ Export JSON</button>

        <label class="mini" style="display:inline-flex;align-items:center;gap:10px;cursor:pointer;">
          ğŸ“¥ Import JSON
          <input id="importJsonInput" type="file" accept="application/json" class="hidden" />
        </label>

        <label class="mini" style="display:inline-flex;align-items:center;gap:10px;cursor:pointer;">
          ğŸ¨ Set background
          <input id="bgPicker" type="file" accept="image/*" class="hidden" />
        </label>

        <button class="mini" id="resetBgBtn">ğŸ§¼ Reset background</button>
        <button class="mini right" id="clearBtn" title="This wipes local data. Export first unless you enjoy pain.">ğŸ§¨ Clear all data</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Source: Nager.Date holidays (cached). SA rule: if a public holiday falls on a Sunday, Monday is also a public holiday.
      </div>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat">
          <div class="k">ğŸ’¸ Last 7 days pay</div>
          <div class="v" id="pay7">R 0.00</div>
        </div>
        <div class="stat">
          <div class="k">ğŸ’° Last 30 days pay</div>
          <div class="v" id="pay30">R 0.00</div>
        </div>
        <div class="stat">
          <div class="k">â±ï¸ Last 7 days hours</div>
          <div class="v" id="hrs7">0.00</div>
        </div>
        <div class="stat">
          <div class="k">ğŸ§  Last 30 days hours</div>
          <div class="v" id="hrs30">0.00</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sectionTop">
        <div style="font-weight:950;">ğŸ“š Shift history</div>
        <div class="small" id="countLabel">0 shifts</div>
      </div>

      <div class="list" id="list"></div>

      <div class="note">
        ğŸ§¾ Export weekly. Phones die. Browsers get â€œcleaned.â€ Your evidence should not.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const KEY_SETTINGS = "pc_petty_settings_v5";
  const KEY_CURRENT  = "pc_petty_currentShift_v5";
  const KEY_SHIFTS   = "pc_petty_shifts_v5";
  const KEY_HOLIDAY  = "pc_petty_holidays_v5";
  const KEY_BG_DATA  = "pc_petty_bg_data_v5";
  const KEY_BG_DIM   = "pc_petty_bg_dim_v5"; // 0-60

  const DEFAULT_TZ = "Africa/Johannesburg";
  const HOLIDAY_COUNTRY = "ZA";
  const HOLIDAY_TTL_DAYS = 45;

  const $ = (id) => document.getElementById(id);

  const tzLabel = $("tzLabel");
  const holidayLabel = $("holidayLabel");
  const integrityLabel = $("integrityLabel");
  const bgLabel = $("bgLabel");

  const clockEl = $("clock");
  const runningBanner = $("runningBanner");
  const runningText = $("runningText");

  const baseRateEl = $("baseRate");
  const tzModeEl = $("tzMode");
  const notesEl = $("notes");

  const startBtn = $("startBtn");
  const endBtn = $("endBtn");

  const pay7El = $("pay7");
  const pay30El = $("pay30");
  const hrs7El = $("hrs7");
  const hrs30El = $("hrs30");
  const countLabel = $("countLabel");
  const listEl = $("list");

  const refreshHolidaysBtn = $("refreshHolidaysBtn");
  const exportCsvBtn = $("exportCsvBtn");
  const exportJsonBtn = $("exportJsonBtn");
  const importJsonInput = $("importJsonInput");
  const clearBtn = $("clearBtn");

  const bgPicker = $("bgPicker");
  const resetBgBtn = $("resetBgBtn");
  const bgDimmer = $("bgDimmer");
  const bgDimLabel = $("bgDimLabel");

  function loadJson(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch{ return fallback; }
  }
  function saveJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function deviceTz(){ return Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC"; }

  function loadSettings(){ return loadJson(KEY_SETTINGS, { baseRate: 0, tzMode: "ZA" }); }
  function saveSettings(patch){
    const s = loadSettings();
    const next = { ...s, ...patch };
    saveJson(KEY_SETTINGS, next);
    return next;
  }
  function getActiveTz(){
    const s = loadSettings();
    return s.tzMode === "DEVICE" ? deviceTz() : DEFAULT_TZ;
  }

  function loadCurrent(){ return loadJson(KEY_CURRENT, null); }
  function saveCurrent(cur){
    if(cur === null) localStorage.removeItem(KEY_CURRENT);
    else saveJson(KEY_CURRENT, cur);
  }

  function loadShifts(){ return loadJson(KEY_SHIFTS, []); }
  function saveShifts(shifts){ saveJson(KEY_SHIFTS, shifts); }

  function money(n){ return "R " + Number(n || 0).toFixed(2); }
  function fmt2(n){ return Number(n || 0).toFixed(2); }
  function calcPay(s){
    const hrs = Number(s?.hours || 0);
    const rate = Number(s?.rateForDay || 0);
    return Number((hrs * rate).toFixed(2));
  }

  function nowTimeInZone(tz){
    return new Intl.DateTimeFormat("en-ZA", {
      timeZone: tz, hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false
    }).format(new Date());
  }
  function dateKeyInZone(d, tz){
    return new Intl.DateTimeFormat("en-CA", {
      timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"
    }).format(d);
  }
  function weekdayInZone(d, tz){
    return new Intl.DateTimeFormat("en-ZA", { timeZone: tz, weekday:"long" }).format(d);
  }
  function isSundayInZone(d, tz){
    const short = new Intl.DateTimeFormat("en-US", { timeZone: tz, weekday:"short" }).format(d);
    return short === "Sun";
  }
  function timeInZone(d, tz){
    return new Intl.DateTimeFormat("en-ZA", {
      timeZone: tz, hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false
    }).format(d);
  }
  function addDays(dateKey, days){
    const dt = new Date(dateKey + "T00:00:00Z");
    dt.setUTCDate(dt.getUTCDate() + days);
    return dt.toISOString().slice(0,10);
  }

  // ===== Background (content:// safe) =====
  function applyBackgroundFromStorage(){
    const dataUrl = localStorage.getItem(KEY_BG_DATA);
    if(dataUrl){
      document.documentElement.style.setProperty("--bgImage", `url("${dataUrl}")`);
      bgLabel.textContent = "custom âœ…";
    }else{
      bgLabel.textContent = "default";
    }
  }

  bgPicker.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    if(file.size > 2_500_000){
      alert("That image is huge. Pick a smaller one (under ~2.5MB) so storage doesnâ€™t cry.");
      bgPicker.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = String(reader.result || "");
      localStorage.setItem(KEY_BG_DATA, dataUrl);
      applyBackgroundFromStorage();
    };
    reader.readAsDataURL(file);
    bgPicker.value = "";
  });

  resetBgBtn.addEventListener("click", () => {
    localStorage.removeItem(KEY_BG_DATA);
    document.documentElement.style.removeProperty("--bgImage");
    applyBackgroundFromStorage();
  });

  // ===== Dimmer slider =====
  function applyDimmer(valPct){
    // valPct: 0..60 (0 = no dim, 60 = darker)
    const pct = Math.max(0, Math.min(60, Number(valPct || 0)));
    localStorage.setItem(KEY_BG_DIM, String(pct));
    bgDimLabel.textContent = `${pct}%`;
    bgDimmer.value = String(pct);

    // Convert to alpha values
    const bottom = (pct / 100) * 0.90;   // cap ~0.54 at 60%
    const top = bottom * 0.35;           // much lighter at top
    document.documentElement.style.setProperty("--bgDimBottom", bottom.toFixed(3));
    document.documentElement.style.setProperty("--bgDimTop", top.toFixed(3));
  }

  bgDimmer.addEventListener("input", () => applyDimmer(bgDimmer.value));

  // ===== Holidays =====
  function loadHolidayCache(){ return loadJson(KEY_HOLIDAY, {}); }
  function saveHolidayCache(c){ saveJson(KEY_HOLIDAY, c); }
  function daysBetween(aMs, bMs){ return Math.abs(aMs - bMs) / (1000*60*60*24); }

  async function fetchHolidaysForYear(year){
    const url = `https://date.nager.at/api/v3/PublicHolidays/${year}/${HOLIDAY_COUNTRY}`;
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Holiday fetch failed");
    const data = await res.json();
    const baseDates = Array.isArray(data) ? data.map(x => x?.date).filter(Boolean) : [];

    const set = new Set(baseDates);
    for(const dk of baseDates){
      const dt = new Date(dk + "T00:00:00Z");
      if(dt.getUTCDay() === 0) set.add(addDays(dk, 1));
    }
    return Array.from(set).sort();
  }

  async function ensureHolidaySet(year, force=false){
    const cache = loadHolidayCache();
    const entry = cache[year];
    const now = Date.now();
    const stale = !entry?.fetchedAt || daysBetween(now, entry.fetchedAt) > HOLIDAY_TTL_DAYS;

    if(entry?.dates && !force && !stale){
      holidayLabel.textContent = `cached (${year}) âœ…`;
      return new Set(entry.dates);
    }

    try{
      holidayLabel.textContent = force ? "refreshingâ€¦ ğŸ”„" : "updatingâ€¦ ğŸ”„";
      const dates = await fetchHolidaysForYear(year);
      cache[year] = { fetchedAt: now, dates };
      saveHolidayCache(cache);
      holidayLabel.textContent = `cached (${year}) âœ…`;
      return new Set(dates);
    }catch{
      if(entry?.dates){
        holidayLabel.textContent = `offline cache (${year}) ğŸ“´`;
        return new Set(entry.dates);
      }
      holidayLabel.textContent = "unavailable âŒ";
      return new Set();
    }
  }

  async function isPublicHoliday(dateKey){
    const year = Number(dateKey.slice(0,4));
    const set = await ensureHolidaySet(year, false);
    return set.has(dateKey);
  }

  function holidayCacheLabel(){
    const cache = loadHolidayCache();
    const years = Object.keys(cache).sort();
    if(!years.length) return "empty ğŸ« ";
    const y = years[years.length - 1];
    const fetchedAt = cache[y]?.fetchedAt;
    if(!fetchedAt) return `cached (${y})`;
    const days = Math.floor(daysBetween(Date.now(), fetchedAt));
    return `cached (${y}, ${days}d ago)`;
  }

  // ===== Hash chain =====
  const supportsCrypto = !!(window.crypto && crypto.subtle);
  const enc = new TextEncoder();

  async function sha256Hex(str){
    const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function canonicalForHash(s, prevHash){
    return [
      s.id, s.startISO, s.endISO, s.tz, s.dateKey, s.weekday,
      String(s.baseRate), String(s.multiplier), String(s.rateForDay),
      String(s.hours), String(s.isPublicHoliday), String(s.isSunday),
      s.notes || "", prevHash || ""
    ].join("|");
  }

  async function verifyChain(shifts){
    if(!supportsCrypto) return null;
    let prev = "";
    for(const s of shifts){
      if((s.prevHash || "") !== prev) return false;
      const h = await sha256Hex(canonicalForHash(s, s.prevHash || ""));
      if(h !== s.hash) return false;
      prev = s.hash;
    }
    return true;
  }

  // ===== UI =====
  function setButtons(){
    const running = !!loadCurrent();
    startBtn.disabled = running;
    endBtn.disabled = !running;
  }

  function renderClock(){
    clockEl.textContent = nowTimeInZone(getActiveTz());
  }

  function renderRunning(){
    const cur = loadCurrent();
    if(!cur){
      runningBanner.classList.remove("running");
      runningText.textContent = "ğŸ˜´ No shift running.";
      return;
    }
    runningBanner.classList.add("running");
    const tz = cur.tzAtStart || getActiveTz();
    const start = new Date(cur.startISO);
    runningText.textContent = `ğŸŸ¢ RUNNING: started ${dateKeyInZone(start, tz)} (${weekdayInZone(start, tz)}) at ${timeInZone(start, tz)}.`;
  }

  function withinDays(endISO, days){
    const end = new Date(endISO).getTime();
    return (Date.now() - end) <= days * 24*60*60*1000;
  }

  function renderStats(shifts){
    const last7 = shifts.filter(s => withinDays(s.endISO, 7));
    const last30 = shifts.filter(s => withinDays(s.endISO, 30));

    const sumPay = arr => arr.reduce((a,s) => a + calcPay(s), 0);
    const sumHrs = arr => arr.reduce((a,s) => a + Number(s.hours || 0), 0);

    pay7El.textContent = money(sumPay(last7));
    pay30El.textContent = money(sumPay(last30));
    hrs7El.textContent = fmt2(sumHrs(last7));
    hrs30El.textContent = fmt2(sumHrs(last30));
  }

  function badgeFor(s){
    if(s.isPublicHoliday) return { cls:"holiday", text:`ğŸ‰ Public Holiday ${s.multiplier.toFixed(1)}x` };
    if(s.isSunday) return { cls:"sunday", text:`â˜€ï¸ Sunday ${s.multiplier.toFixed(1)}x` };
    return { cls:"normal", text:`ğŸ˜ Normal ${s.multiplier.toFixed(1)}x` };
  }

  function renderList(shifts){
    countLabel.textContent = `${shifts.length} shift${shifts.length === 1 ? "" : "s"} ğŸ“Œ`;
    listEl.innerHTML = "";

    const show = shifts.slice().reverse().slice(0, 30);
    if(!show.length){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="small">No shifts yet. Hit <b>ğŸŸ¢ START SHIFT</b> then <b>ğŸ”´ END SHIFT</b>. Thatâ€™s the whole religion.</div>`;
      listEl.appendChild(empty);
      return;
    }

    for(const s of show){
      const start = new Date(s.startISO);
      const end = new Date(s.endISO);
      const b = badgeFor(s);
      const pay = calcPay(s);

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="dateLine">ğŸ“… ${s.dateKey} (${escapeHtml(s.weekday)})</div>
            <div class="small">ğŸŒ TZ: ${escapeHtml(s.tz)}</div>
          </div>
          <div class="badge ${b.cls}">${escapeHtml(b.text)}</div>
        </div>

        <div class="payBig">
          <div class="pay">ğŸ’¸ ${money(pay)}</div>
          <div class="meta">â±ï¸ ${fmt2(s.hours)} hrs Â· ğŸ’° ${money(s.rateForDay)}/hr</div>
        </div>

        <div class="kvGrid">
          <div class="kv">ğŸŸ¢ Start: <b>${timeInZone(start, s.tz)}</b></div>
          <div class="kv">ğŸ”´ End: <b>${timeInZone(end, s.tz)}</b></div>
          <div class="kv">ğŸ’° Base: <b>${money(s.baseRate)}/hr</b></div>
          <div class="kv">ğŸ“ˆ Multiplier: <b>${s.multiplier.toFixed(2)}x</b></div>
          <div class="kv">ğŸ”’ Hash: <b title="${escapeHtml(s.hash || "")}">${(s.hash || "â€”").slice(0,10)}â€¦</b></div>
          <div class="kv">ğŸ§¬ Prev: <b title="${escapeHtml(s.prevHash || "")}">${(s.prevHash || "â€”").slice(0,10)}â€¦</b></div>
        </div>

        ${s.notes ? `<div class="small" style="margin-top:10px;">ğŸ“ Notes: ${escapeHtml(s.notes)}</div>` : ``}
      `;
      listEl.appendChild(el);
    }
  }

  async function refreshAll(){
    tzLabel.textContent = getActiveTz();
    holidayLabel.textContent = holidayCacheLabel();

    setButtons();
    renderClock();
    renderRunning();

    const shifts = loadShifts();
    renderStats(shifts);
    renderList(shifts);

    const integrity = await verifyChain(shifts);
    if(integrity === null){
      integrityLabel.textContent = "unsupported ğŸ¤·";
      integrityLabel.className = "";
    }else if(integrity){
      integrityLabel.textContent = "OK âœ…";
      integrityLabel.className = "goodText";
    }else{
      integrityLabel.textContent = "BROKEN ğŸ’€";
      integrityLabel.className = "badText";
    }
  }

  function requireRate(){
    const r = Number(baseRateEl.value);
    return Number.isFinite(r) && r > 0 ? r : 0;
  }

  startBtn.addEventListener("click", async () => {
    const baseRate = requireRate();
    if(!baseRate){ alert("Set a base hourly rate first."); return; }

    const tz = getActiveTz();
    const start = new Date();

    saveCurrent({ startISO: start.toISOString(), baseRate: Number(baseRate.toFixed(2)), tzAtStart: tz });

    const dk = dateKeyInZone(start, tz);
    await ensureHolidaySet(Number(dk.slice(0,4)), false);

    await refreshAll();
  });

  endBtn.addEventListener("click", async () => {
    const cur = loadCurrent();
    if(!cur) return;

    const tz = cur.tzAtStart || getActiveTz();
    const start = new Date(cur.startISO);
    const end = new Date();

    if(end.getTime() <= start.getTime()){
      alert("End time is not after start time. Time travel is not payroll-safe.");
      return;
    }

    const dateKey = dateKeyInZone(start, tz);
    const weekday = weekdayInZone(start, tz);
    const sunday = isSundayInZone(start, tz);
    const holiday = await isPublicHoliday(dateKey);

    const multiplier = holiday ? 2.0 : (sunday ? 1.5 : 1.0);

    const baseRate = Number(cur.baseRate || requireRate() || 0);
    if(!baseRate){ alert("Missing base rate. Set it and try again."); return; }

    const hours = (end.getTime() - start.getTime()) / (1000*60*60);
    const rateForDay = Number((baseRate * multiplier).toFixed(2));
    const pay = Number((rateForDay * hours).toFixed(2));

    const shifts = loadShifts();
    const prevHash = shifts.length ? (shifts[shifts.length - 1].hash || "") : "";

    const record = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
      startISO: start.toISOString(),
      endISO: end.toISOString(),
      tz,
      dateKey,
      weekday,
      baseRate: Number(baseRate.toFixed(2)),
      multiplier,
      rateForDay,
      hours: Number(hours.toFixed(4)),
      pay,
      isPublicHoliday: holiday,
      isSunday: sunday,
      notes: (notesEl.value || "").trim(),
      prevHash,
      hash: ""
    };

    if(supportsCrypto) record.hash = await sha256Hex(canonicalForHash(record, prevHash));
    else record.hash = "unsupported";

    shifts.push(record);
    saveShifts(shifts);
    saveCurrent(null);
    notesEl.value = "";

    await refreshAll();
  });

  baseRateEl.addEventListener("change", () => {
    const r = Number(baseRateEl.value);
    saveSettings({ baseRate: (Number.isFinite(r) ? r : 0) });
  });

  tzModeEl.addEventListener("change", async () => {
    saveSettings({ tzMode: tzModeEl.value });
    await refreshAll();
  });

  refreshHolidaysBtn.addEventListener("click", async () => {
    const year = Number(dateKeyInZone(new Date(), getActiveTz()).slice(0,4));
    await ensureHolidaySet(year, true);
    await refreshAll();
  });

  function downloadFile(filename, mime, content){
    const blob = new Blob([content], { type:mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  exportCsvBtn.addEventListener("click", () => {
    const shifts = loadShifts();
    const headers = ["Date","Weekday","StartISO","EndISO","Hours","BaseRate","Multiplier","RateForDay","Pay","IsPublicHoliday","IsSunday","Timezone","Notes","PrevHash","Hash"];
    const rows = shifts.map(s => ([
      s.dateKey, s.weekday, s.startISO, s.endISO, s.hours,
      s.baseRate, s.multiplier, s.rateForDay, calcPay(s),
      s.isPublicHoliday, s.isSunday, s.tz, (s.notes || ""),
      s.prevHash || "", s.hash || ""
    ]));
    const csv = [headers.join(","), ...rows.map(r => r.map(v => {
      const str = String(v ?? "");
      return /[",\n]/.test(str) ? `"${str.replaceAll('"','""')}"` : str;
    }).join(","))].join("\n");
    downloadFile(`punchclock-${new Date().toISOString().slice(0,10)}.csv`, "text/csv", csv);
  });

  exportJsonBtn.addEventListener("click", () => {
    const payload = {
      exportedAt: new Date().toISOString(),
      app: "PunchClock: Petty Edition ğŸš¨ğŸ‡¿ğŸ‡¦",
      settings: loadSettings(),
      holidays: loadHolidayCache(),
      shifts: loadShifts(),
      backgroundSet: !!localStorage.getItem(KEY_BG_DATA),
      bgDimmer: Number(localStorage.getItem(KEY_BG_DIM) || 22)
    };
    downloadFile(`punchclock-${new Date().toISOString().slice(0,10)}.json`, "application/json", JSON.stringify(payload, null, 2));
  });

  importJsonInput.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const text = await file.text();
    try{
      const obj = JSON.parse(text);
      if(!obj || !Array.isArray(obj.shifts)) throw new Error("Invalid JSON");
      if(!confirm("Import will REPLACE your local data. Proceed?")) return;
      if(obj.settings) saveJson(KEY_SETTINGS, obj.settings);
      if(obj.holidays) saveJson(KEY_HOLIDAY, obj.holidays);
      saveJson(KEY_SHIFTS, obj.shifts);
      saveCurrent(null);
      await refreshAll();
      alert("Imported âœ…");
    }catch{
      alert("That JSON file isnâ€™t valid for this app âŒ");
    }finally{
      importJsonInput.value = "";
    }
  });

  clearBtn.addEventListener("click", () => {
    if(!confirm("This wipes ALL shifts/settings/holiday cache/background/dimmer. Export first unless chaos is your brand. Proceed?")) return;
    localStorage.removeItem(KEY_SETTINGS);
    localStorage.removeItem(KEY_CURRENT);
    localStorage.removeItem(KEY_SHIFTS);
    localStorage.removeItem(KEY_HOLIDAY);
    localStorage.removeItem(KEY_BG_DATA);
    localStorage.removeItem(KEY_BG_DIM);
    location.reload();
  });

  function init(){
    const s = loadSettings();
    baseRateEl.value = (s.baseRate && Number(s.baseRate) > 0) ? Number(s.baseRate).toFixed(2) : "";
    tzModeEl.value = s.tzMode || "ZA";

    applyBackgroundFromStorage();

    const savedDim = Number(localStorage.getItem(KEY_BG_DIM) || 22);
    applyDimmer(savedDim);

    tzLabel.textContent = getActiveTz();
    holidayLabel.textContent = holidayCacheLabel();
    refreshAll();
  }

  init();
  setInterval(renderClock, 250);
  setInterval(() => { renderRunning(); setButtons(); }, 900);
})();
</script>
</body>
</html>